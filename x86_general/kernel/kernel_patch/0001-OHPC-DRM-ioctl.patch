From 0ca2199e9f7f8b85a5475e795304f4f97521086a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E8=B4=BA=E5=B0=8F=E5=B8=85?= <hxsjs@qq.com>
Date: Wed, 28 Aug 2024 12:39:08 +0800
Subject: [PATCH 1/3] =?UTF-8?q?[OHPC]=20=E7=A7=BB=E9=99=A4DRM=E9=A9=B1?=
 =?UTF-8?q?=E5=8A=A8ioctl=E6=9D=83=E9=99=90=E6=A3=80=E6=9F=A5(=E8=A7=A3?=
 =?UTF-8?q?=E5=86=B3=E6=97=A0=E6=98=BE=E7=A4=BA).?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Change-Id: I8cc5ec3dbee806dedf47284eb5639aa658c3a96b
---
 drivers/gpu/drm/Kconfig     | 4 ++++
 drivers/gpu/drm/drm_ioctl.c | 2 ++
 2 files changed, 6 insertions(+)

diff --git a/drivers/gpu/drm/Kconfig b/drivers/gpu/drm/Kconfig
index ec4abf9ff47b..7cecfaad551d 100644
--- a/drivers/gpu/drm/Kconfig
+++ b/drivers/gpu/drm/Kconfig
@@ -436,3 +436,7 @@ config DRM_LIB_RANDOM
 config DRM_PRIVACY_SCREEN
 	bool
 	default n
+
+config DRM_IGNORE_IOTCL_PERMIT
+	bool "Ignore drm ioctl permission"
+	depends on DRM
diff --git a/drivers/gpu/drm/drm_ioctl.c b/drivers/gpu/drm/drm_ioctl.c
index 77590b0f38fa..bbb3cec9b3af 100644
--- a/drivers/gpu/drm/drm_ioctl.c
+++ b/drivers/gpu/drm/drm_ioctl.c
@@ -529,6 +529,7 @@ int drm_version(struct drm_device *dev, void *data,
 
 static int drm_ioctl_permit(u32 flags, struct drm_file *file_priv)
 {
+#ifndef CONFIG_DRM_IGNORE_IOTCL_PERMIT
 	/* ROOT_ONLY is only for CAP_SYS_ADMIN */
 	if (unlikely((flags & DRM_ROOT_ONLY) && !capable(CAP_SYS_ADMIN)))
 		return -EACCES;
@@ -547,6 +548,7 @@ static int drm_ioctl_permit(u32 flags, struct drm_file *file_priv)
 	if (unlikely(!(flags & DRM_RENDER_ALLOW) &&
 		     drm_is_render_client(file_priv)))
 		return -EACCES;
+#endif
 
 	return 0;
 }
-- 
2.34.1

