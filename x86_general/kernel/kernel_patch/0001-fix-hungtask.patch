From 00dc3fe833999080a8fdc0b9b2ab0d518c4cc769 Mon Sep 17 00:00:00 2001
From: diemit <598757652@qq.com>
Date: Sat, 17 May 2025 10:15:59 +0800
Subject: [PATCH] fix hungtask

Change-Id: Ie11073bbd2586095f11c9c6513c58ca1cd40e08e
---
 include/linux/sched/signal.h | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/include/linux/sched/signal.h b/include/linux/sched/signal.h
index 0014d3ada..669e8cff4 100644
--- a/include/linux/sched/signal.h
+++ b/include/linux/sched/signal.h
@@ -649,9 +649,12 @@ extern void flush_itimer_signals(void);
 extern bool current_is_single_threaded(void);
 
 /*
- * Without tasklist/siglock it is only rcu-safe if g can't exit/exec,
- * otherwise next_thread(t) will never reach g after list_del_rcu(g).
+ * Careful: do_each_thread/while_each_thread is a double loop so
+ *          'break' will not work as expected - use goto instead.
  */
+#define do_each_thread(g, t) \
+	for (g = t = &init_task ; (g = t = next_task(g)) != &init_task ; ) do
+
 #define while_each_thread(g, t) \
 	while ((t = next_thread(t)) != g)
 
-- 
2.25.1

